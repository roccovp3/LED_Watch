#include "ti_msp_dl_config.h"
#include "LEDs.h"

const watch_led_t min_1 = {0, 1, GPIO_GRP_0_PIN_2_PIN, GPIO_GRP_0_PIN_7_PIN, 34, 14};
const watch_led_t min_2 = {0, 2, GPIO_GRP_0_PIN_2_PIN, GPIO_GRP_0_PIN_12_PIN, 34, 35};
const watch_led_t min_3 = {0, 3, GPIO_GRP_0_PIN_2_PIN, GPIO_GRP_0_PIN_13_PIN, 34, 55};
const watch_led_t min_4 = {0, 4, GPIO_GRP_0_PIN_2_PIN, GPIO_GRP_0_PIN_25_PIN, 34, 21};
const watch_led_t min_5 = {0, 5, GPIO_GRP_0_PIN_2_PIN, GPIO_GRP_0_PIN_10_PIN, 14, 34};
const watch_led_t min_6 = {0, 6, GPIO_GRP_0_PIN_2_PIN, GPIO_GRP_0_PIN_8_PIN, 14, 35};
const watch_led_t min_7 = {0, 7, GPIO_GRP_0_PIN_2_PIN, GPIO_GRP_0_PIN_5_PIN, 14, 55};
const watch_led_t min_8 = {0, 8, GPIO_GRP_0_PIN_2_PIN, GPIO_GRP_0_PIN_4_PIN, 14, 21};
const watch_led_t min_9 = {0, 9, GPIO_GRP_0_PIN_4_PIN, GPIO_GRP_0_PIN_7_PIN, 14, 19};
const watch_led_t min_10 = {0, 10, GPIO_GRP_0_PIN_4_PIN, GPIO_GRP_0_PIN_12_PIN, 14, 10};
const watch_led_t min_11 = {0, 11, GPIO_GRP_0_PIN_4_PIN, GPIO_GRP_0_PIN_13_PIN, 14, 7};
const watch_led_t min_12 = {0, 12, GPIO_GRP_0_PIN_4_PIN, GPIO_GRP_0_PIN_25_PIN, 14, 9};
const watch_led_t min_13 = {0, 13, GPIO_GRP_0_PIN_4_PIN, GPIO_GRP_0_PIN_10_PIN, 34, 14};
const watch_led_t min_14 = {0, 14, GPIO_GRP_0_PIN_4_PIN, GPIO_GRP_0_PIN_8_PIN, 34, 35};
const watch_led_t min_15 = {0, 15, GPIO_GRP_0_PIN_4_PIN, GPIO_GRP_0_PIN_5_PIN, 34, 55};
const watch_led_t min_16 = {0, 16, GPIO_GRP_0_PIN_4_PIN, GPIO_GRP_0_PIN_2_PIN, 34, 21};
const watch_led_t min_17 = {0, 17, GPIO_GRP_0_PIN_12_PIN, GPIO_GRP_0_PIN_8_PIN, 14, 34};
const watch_led_t min_18 = {0, 18, GPIO_GRP_0_PIN_12_PIN, GPIO_GRP_0_PIN_5_PIN, 14, 35};
const watch_led_t min_19 = {0, 19, GPIO_GRP_0_PIN_12_PIN, GPIO_GRP_0_PIN_2_PIN, 14, 55};
const watch_led_t min_20 = {0, 20, GPIO_GRP_0_PIN_12_PIN, GPIO_GRP_0_PIN_4_PIN, 14, 21};
const watch_led_t min_21 = {0, 21, GPIO_GRP_0_PIN_13_PIN, GPIO_GRP_0_PIN_7_PIN, 14, 19};
const watch_led_t min_22 = {0, 22, GPIO_GRP_0_PIN_13_PIN, GPIO_GRP_0_PIN_12_PIN, 14, 10};
const watch_led_t min_23 = {0, 23, GPIO_GRP_0_PIN_13_PIN, GPIO_GRP_0_PIN_25_PIN, 14, 7};
const watch_led_t min_24 = {0, 24, GPIO_GRP_0_PIN_13_PIN, GPIO_GRP_0_PIN_10_PIN, 14, 9};
const watch_led_t min_25 = {0, 25, GPIO_GRP_0_PIN_13_PIN, GPIO_GRP_0_PIN_8_PIN, 34, 14};
const watch_led_t min_26 = {0, 26, GPIO_GRP_0_PIN_13_PIN, GPIO_GRP_0_PIN_5_PIN, 34, 35};
const watch_led_t min_27 = {0, 27, GPIO_GRP_0_PIN_13_PIN, GPIO_GRP_0_PIN_2_PIN, 34, 55};
const watch_led_t min_28 = {0, 28, GPIO_GRP_0_PIN_13_PIN, GPIO_GRP_0_PIN_4_PIN, 34, 21};
const watch_led_t min_29 = {0, 29, GPIO_GRP_0_PIN_25_PIN, GPIO_GRP_0_PIN_7_PIN, 14, 34};
const watch_led_t min_30 = {0, 30, GPIO_GRP_0_PIN_25_PIN, GPIO_GRP_0_PIN_12_PIN, 14, 35};
const watch_led_t min_31 = {0, 31, GPIO_GRP_0_PIN_25_PIN, GPIO_GRP_0_PIN_13_PIN, 14, 55};
const watch_led_t min_32 = {0, 32, GPIO_GRP_0_PIN_25_PIN, GPIO_GRP_0_PIN_10_PIN, 14, 21};
const watch_led_t min_33 = {0, 33, GPIO_GRP_0_PIN_25_PIN, GPIO_GRP_0_PIN_8_PIN, 14, 19};
const watch_led_t min_34 = {0, 34, GPIO_GRP_0_PIN_25_PIN, GPIO_GRP_0_PIN_5_PIN, 14, 10};
const watch_led_t min_35 = {0, 35, GPIO_GRP_0_PIN_25_PIN, GPIO_GRP_0_PIN_2_PIN, 14, 7};
const watch_led_t min_36 = {0, 36, GPIO_GRP_0_PIN_25_PIN, GPIO_GRP_0_PIN_4_PIN, 14, 9};
const watch_led_t min_37 = {0, 37, GPIO_GRP_0_PIN_10_PIN, GPIO_GRP_0_PIN_7_PIN, 34, 14};
const watch_led_t min_38 = {0, 38, GPIO_GRP_0_PIN_10_PIN, GPIO_GRP_0_PIN_12_PIN, 34, 35};
const watch_led_t min_39 = {0, 39, GPIO_GRP_0_PIN_10_PIN, GPIO_GRP_0_PIN_13_PIN, 34, 55};
const watch_led_t min_40 = {0, 40, GPIO_GRP_0_PIN_10_PIN, GPIO_GRP_0_PIN_25_PIN, 34, 21};
const watch_led_t min_41 = {0, 41, GPIO_GRP_0_PIN_10_PIN, GPIO_GRP_0_PIN_8_PIN, 14, 34};
const watch_led_t min_42 = {0, 42, GPIO_GRP_0_PIN_10_PIN, GPIO_GRP_0_PIN_5_PIN, 14, 35};
const watch_led_t min_43 = {0, 43, GPIO_GRP_0_PIN_10_PIN, GPIO_GRP_0_PIN_2_PIN, 14, 55};
const watch_led_t min_44 = {0, 44, GPIO_GRP_0_PIN_10_PIN, GPIO_GRP_0_PIN_4_PIN, 14, 21};
const watch_led_t min_45 = {0, 45, GPIO_GRP_0_PIN_8_PIN, GPIO_GRP_0_PIN_7_PIN, 14, 19};
const watch_led_t min_46 = {0, 46, GPIO_GRP_0_PIN_8_PIN, GPIO_GRP_0_PIN_12_PIN, 14, 10};
const watch_led_t min_47 = {0, 47, GPIO_GRP_0_PIN_8_PIN, GPIO_GRP_0_PIN_13_PIN, 14, 7};
const watch_led_t min_48 = {0, 48, GPIO_GRP_0_PIN_8_PIN, GPIO_GRP_0_PIN_25_PIN, 14, 9};
const watch_led_t min_49 = {0, 49, GPIO_GRP_0_PIN_8_PIN, GPIO_GRP_0_PIN_10_PIN, 34, 14};
const watch_led_t min_50 = {0, 50, GPIO_GRP_0_PIN_8_PIN, GPIO_GRP_0_PIN_5_PIN, 34, 35};
const watch_led_t min_51 = {0, 51, GPIO_GRP_0_PIN_8_PIN, GPIO_GRP_0_PIN_2_PIN, 34, 55};
const watch_led_t min_52 = {0, 52, GPIO_GRP_0_PIN_8_PIN, GPIO_GRP_0_PIN_4_PIN, 34, 21};
const watch_led_t min_53 = {0, 53, GPIO_GRP_0_PIN_5_PIN, GPIO_GRP_0_PIN_7_PIN, 14, 34};
const watch_led_t min_54 = {0, 54, GPIO_GRP_0_PIN_5_PIN, GPIO_GRP_0_PIN_12_PIN, 14, 35};
const watch_led_t min_55 = {0, 55, GPIO_GRP_0_PIN_5_PIN, GPIO_GRP_0_PIN_13_PIN, 14, 55};
const watch_led_t min_56 = {0, 56, GPIO_GRP_0_PIN_5_PIN, GPIO_GRP_0_PIN_25_PIN, 14, 21};
const watch_led_t min_57 = {0, 57, GPIO_GRP_0_PIN_5_PIN, GPIO_GRP_0_PIN_10_PIN, 14, 19};
const watch_led_t min_58 = {0, 58, GPIO_GRP_0_PIN_5_PIN, GPIO_GRP_0_PIN_8_PIN, 14, 10};
const watch_led_t min_59 = {0, 59, GPIO_GRP_0_PIN_5_PIN, GPIO_GRP_0_PIN_2_PIN, 14, 7};
const watch_led_t min_60 = {0, 60, GPIO_GRP_0_PIN_5_PIN, GPIO_GRP_0_PIN_4_PIN, 14, 9};



const watch_led_t hour_1 = {1, 1, GPIO_GRP_0_PIN_12_PIN, GPIO_GRP_0_PIN_7_PIN, 34, 14};
const watch_led_t hour_2 = {1, 2, GPIO_GRP_0_PIN_12_PIN, GPIO_GRP_0_PIN_13_PIN, 34, 35};
const watch_led_t hour_3 = {1, 3, GPIO_GRP_0_PIN_12_PIN, GPIO_GRP_0_PIN_25_PIN, 34, 55};
const watch_led_t hour_4 = {1, 4, GPIO_GRP_0_PIN_12_PIN, GPIO_GRP_0_PIN_10_PIN, 34, 21};
const watch_led_t hour_5 = {1, 5, GPIO_GRP_0_PIN_7_PIN, GPIO_GRP_0_PIN_12_PIN, 14, 34};
const watch_led_t hour_6 = {1, 6, GPIO_GRP_0_PIN_7_PIN, GPIO_GRP_0_PIN_13_PIN, 14, 35};
const watch_led_t hour_7 = {1, 7, GPIO_GRP_0_PIN_7_PIN, GPIO_GRP_0_PIN_25_PIN, 14, 55};
const watch_led_t hour_8 = {1, 8, GPIO_GRP_0_PIN_7_PIN, GPIO_GRP_0_PIN_10_PIN, 14, 21};
const watch_led_t hour_9 = {1, 9, GPIO_GRP_0_PIN_7_PIN, GPIO_GRP_0_PIN_8_PIN, 14, 19};
const watch_led_t hour_10 = {1, 10, GPIO_GRP_0_PIN_7_PIN, GPIO_GRP_0_PIN_5_PIN, 14, 10};
const watch_led_t hour_11 = {1, 11, GPIO_GRP_0_PIN_7_PIN, GPIO_GRP_0_PIN_2_PIN, 14, 7};
const watch_led_t hour_12 = {1, 12, GPIO_GRP_0_PIN_7_PIN, GPIO_GRP_0_PIN_4_PIN, 14, 9};
const watch_led_t hour_12_rollover = {1, 12, GPIO_GRP_0_PIN_7_PIN, GPIO_GRP_0_PIN_4_PIN, 14, 9};

const watch_led_t *hour_leds[12] = {&hour_12,&hour_1, &hour_2, &hour_3, &hour_4, &hour_5, &hour_6, &hour_7, &hour_8, &hour_9, &hour_10, &hour_11};
const watch_led_t *min_leds[60] = {
    &min_60,  &min_1,  &min_2,  &min_3,  &min_4,  &min_5,  &min_6,  &min_7,  &min_8,  &min_9,
    &min_10, &min_11, &min_12, &min_13, &min_14, &min_15, &min_16, &min_17, &min_18, &min_19,
    &min_20, &min_21, &min_22, &min_23, &min_24, &min_25, &min_26, &min_27, &min_28, &min_29,
    &min_30, &min_31, &min_32, &min_33, &min_34, &min_35, &min_36, &min_37, &min_38, &min_39,
    &min_40, &min_41, &min_42, &min_43, &min_44, &min_45, &min_46, &min_47, &min_48, &min_49,
    &min_50, &min_51, &min_52, &min_53, &min_54, &min_55, &min_56, &min_57, &min_58, &min_59
};

const watch_led_t *all_leds[72] = {
    &min_60,  &min_1,  &min_2,  &min_3,  &min_4,  &min_5,  &min_6,  &min_7,  &min_8,  &min_9,
    &min_10, &min_11, &min_12, &min_13, &min_14, &min_15, &min_16, &min_17, &min_18, &min_19,
    &min_20, &min_21, &min_22, &min_23, &min_24, &min_25, &min_26, &min_27, &min_28, &min_29,
    &min_30, &min_31, &min_32, &min_33, &min_34, &min_35, &min_36, &min_37, &min_38, &min_39,
    &min_40, &min_41, &min_42, &min_43, &min_44, &min_45, &min_46, &min_47, &min_48, &min_49,
    &min_50, &min_51, &min_52, &min_53, &min_54, &min_55, &min_56, &min_57, &min_58, &min_59,

    &hour_12,&hour_1, &hour_2, &hour_3, &hour_4, &hour_5, &hour_6, &hour_7, &hour_8, &hour_9, &hour_10, &hour_11
};
uint8_t hour_index = 11;
uint8_t min_index = 0;
uint8_t sec_index = 0;

static void disable_all() {
    const watch_led_t *hour_led = hour_leds[hour_index];
    const watch_led_t *min_led = min_leds[min_index];
    const watch_led_t *sec_led = min_leds[sec_index]; // min and sec LEDs are shared
    GPIOA->DOE31_0  &= ~(sec_led->anode_pin | sec_led->cathode_pin);
    GPIOA->DOE31_0  &= ~(min_led->anode_pin | min_led->cathode_pin);
    GPIOA->DOE31_0  &= ~(hour_led->anode_pin | hour_led->cathode_pin);
}

void led_out(uint32_t cycle_count) {
    const watch_led_t *hour_led = hour_leds[hour_index];
    const watch_led_t *min_led = min_leds[min_index];
    const watch_led_t *sec_led = min_leds[sec_index]; // min and sec LEDs are shared

    // brightness adjustment by allocating each LED an appropriate timeslot
    if(cycle_count % 512 < 450) {
        GPIOA->DOE31_0  &= ~(min_led->anode_pin | min_led->cathode_pin);
        GPIOA->DOE31_0  &= ~(sec_led->anode_pin | sec_led->cathode_pin);
        GPIOA->DOE31_0  |= (hour_led->anode_pin | hour_led->cathode_pin);
        GPIOA->DOUT31_0 |= hour_led->anode_pin;
        GPIOA->DOUT31_0 &= ~(hour_led->cathode_pin);
    }
    else if ((cycle_count % 512 >= 450) && (cycle_count % 512 < 481)) {
        GPIOA->DOE31_0  &= ~(sec_led->anode_pin | sec_led->cathode_pin);
        GPIOA->DOE31_0  &= ~(hour_led->anode_pin | hour_led->cathode_pin);
        GPIOA->DOE31_0  |= (min_led->anode_pin | min_led->cathode_pin);
        GPIOA->DOUT31_0 |= min_led->anode_pin;
        GPIOA->DOUT31_0 &= ~(min_led->cathode_pin);
    }
    else {
        GPIOA->DOE31_0  &= ~(min_led->anode_pin | min_led->cathode_pin);
        GPIOA->DOE31_0  &= ~(hour_led->anode_pin | hour_led->cathode_pin);
        GPIOA->DOE31_0  |= (sec_led->anode_pin | sec_led->cathode_pin);
        GPIOA->DOUT31_0 |= sec_led->anode_pin;
        GPIOA->DOUT31_0 &= ~(sec_led->cathode_pin);
    }
}

void next_led_out(uint8_t mode) {
    disable_all();
    if(mode == 0) {
        if(sec_index == 59) {
            if(min_index == 59) {
                hour_index = (hour_index + 1) % 12;
            }
            min_index = (min_index + 1) % 60;
        }
        sec_index = (sec_index + 1) % 60;
    }
    else if(mode == 1) {
        if(min_index == 59) {
            hour_index = (hour_index + 1) % 12;
        }
        min_index = (min_index + 1) % 60;
    }
    else if(mode == 2) {
        hour_index = (hour_index + 1) % 12;
    }
}